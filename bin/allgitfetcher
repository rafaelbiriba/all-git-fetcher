#!/bin/bash
# Created by Rafael Biriba
# Email: biribarj@gmail.com
# Documentation at github.com/rafaelbiriba/all-git-fetcher
# Short description:
# Update all git directories below current directory or specified directory
# Skips directories that contain a file called .allfetch_ignore

BLUE="\e[0;34m"
RED="\e[0;31m"
YELLOW="\e[1;33m"
GREEN="\e[1;32m"
WHITE='\e[0m'
WHITEUNDER='\e[4;37m'

function update {
  local path="$1"
  if [ -d "$path" ]; then
    cd $path > /dev/null
    if [ -d ".git" ]; then
      current_path=`pwd`
      printf "${WHITE}Project ${WHITEUNDER}${current_path#$running_directory}${WHITE}: \n"
      printf "       "

      if [ -e ".allfetch_ignore" ]; then
        printf "${RED}Ignored: .allfetch_ignore detected... "
        printf "${WHITE}--- ${GREEN}ALL DONE"
        return;
      fi

      if [[ -z `grep "fetch" .git/config` ]]; then
        printf "${RED}Ignored: No remote detected to fetch... "
        printf "${WHITE}--- ${GREEN}ALL DONE"
        return;
      fi

      printf "${YELLOW}Git Fetching... "
      git fetch > /dev/null 2>&1
      printf "${GREEN}OK! "
      printf "${WHITE}- ${YELLOW}Git Rebasing origin/master... "
      status=`git status`

      if [[ "$status" =~ "nothing to commit" ]]; then
        git rebase origin/master > /dev/null 2>&1
        printf "${GREEN}OK! "
      else
        printf "${RED}Ignored: Modifications not committed! "
      fi

      printf "${WHITE}--- ${GREEN}ALL DONE!!!\n"
    else
      scan *
    fi

    cd .. > /dev/null
  fi
}

function scan {
  for x in $*; do
    update "$x"
  done
}

running_directory=`pwd`/
printf "####################################################\n"
printf "##                ${YELLOW}ALL GIT Fetcher${WHITE}                 ##\n"
printf "## Visit: github.com/rafaelbiriba/all-git-fetcher ##\n"
printf "####################################################\n\n"
printf "${WHITE}Scanning for local projects directories at ${YELLOW}${running_directory}${WHITE}: \n\n"
scan *
printf "\n\n"
